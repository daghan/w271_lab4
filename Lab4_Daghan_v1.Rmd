---
title: "W271 Section 3 Lab 4"
author: "Kiersten Henderson, Zhaoning Yu, Daghan Altas"
date: "12/09/2017"
output:
  pdf_document: default
  html_notebook: default
  html_document: default
---

```{r results='hide', message=FALSE, warning=FALSE, echo=FALSE}
knitr::opts_chunk$set(cache=TRUE)
library(knitr)
library(xts)
library(forecast)
library(ggfortify)
library(ggplot2)
library(dplyr)
library(plotly)
library(Hmisc)
library(tseries)
library(stats)
opts_chunk$set(tidy.opts=list(width.cutoff=60),tidy=TRUE)
rm(list=ls())
```
# Introduction


# Loading and cleaning up the data
We'll load the data and convert it to an xts object for easy subsetting
```{r}
setwd("/Users/daghan/Hacking/Berkeley/W271/Labs/w271_lab4")
df <- read.csv("./Lab4-series2.csv")
rbind(head(df), tail(df))
str(df)
describe(df)
```

There are no missing variables and the first column is the index column, which can be discarded. 
We are going to convert the data to a (xts) based time seres

```{r}
ms <- as.xts(ts(df$x, start = c(1990,1), frequency = 12))
ms.training <- ms['/2014']
rbind(head(ms.training), tail(ms.training))
ms.test <- ms['2015/']
```

# Exploratory Time Series Data Analysis
```{r}
ms.training %>% autoplot()
ms.training %>% ggtsdisplay  
```
The series both show a trend and a seasonal component. It is not stationary in the mean.
The seasonal component can be seen in the PACF graph. The ACF/PACF graph also suggest a AR model
We are going to use differencing to transform it to a weakly stationary time series.

```{r}
ms.training.1d <- diff(ms.training, lag = 1) 
ms.training.4d <- diff(ms.training, lag = 4) 
ms.training.12d <- diff(ms.training, lag = 12)
ms.training.1d.4d <- diff(diff(ms.training, lag = 1), lag = 4)
ms.training.1d.12d <- diff(diff(ms.training, lag = 1), lag = 12)

#prunning the NAs
ms.training.1d <- ms.training.1d[!is.na(ms.training.1d)]
ms.training.4d <- ms.training.4d[!is.na(ms.training.4d)]
ms.training.12d <- ms.training.12d[!is.na(ms.training.12d)]
ms.training.1d.4d <- ms.training.1d.4d[!is.na(ms.training.1d.4d)]
ms.training.1d.12d <- ms.training.1d.12d[!is.na(ms.training.1d.12d)]

ms.training.1d %>% ggtsdisplay
ms.training.4d %>% ggtsdisplay
ms.training.12d %>% ggtsdisplay
ms.training.1d.4d %>% ggtsdisplay
ms.training.1d.12d %>% ggtsdisplay
```

## Testing for weak stationarity  


```{r}
adf.test(ms.training.1d)
adf.test(ms.training.4d)
adf.test(ms.training.12d)
adf.test(ms.training.1d.4d)
adf.test(ms.training.1d.12d)
```

The stationarity tests don't allow us to distinguish among different models. 

## Expand here 

We have decided to use a regular differencing of 1 as well as a seasonal differencing of 1 (for a lag of 12). Our search space model is $ARIMA(p,1,q)(P,1,Q)_{12}$

Both ACF and PACF point to a strong seasonal MA(1) component. The ACF/PACF suggest that there could be a mild AR(2) component (decaying ACF component, with a drop in PACF). It is worth noting that there is a spike at lag(5), so we'll expand our p/q search to lag(5).

# Model search

## Some models based on the ETSDA

```{r}
# ARIMA(0,1,0)(0,1,1)[12]
ms.training %>% Arima(order = c(0, 1, 0), seasonal=list(order=c(0,1,1),period=12)) %>% residuals %>% ggtsdisplay

# ARIMA(2,1,0)(0,1,1)[12]
ms.training %>% Arima(order = c(2, 1, 0), seasonal=list(order=c(0,1,1),period=12)) %>% residuals %>% ggtsdisplay

# ARIMA(2,1,5)(0,1,1)[12]
ms.training %>% Arima(order = c(2, 1, 5), seasonal=list(order=c(0,1,1),period=12)) %>% residuals %>% ggtsdisplay

# ARIMA(5,1,0)(0,1,1)[12]
ms.training %>% Arima(order = c(5, 1, 0), seasonal=list(order=c(0,1,1),period=12)) %>% residuals %>% ggtsdisplay
```

Both ARIMA(2,1,5)(0,1,1)[12] and ARIMA(5,1,0)(0,1,1)[12] models perform really well from a ACF/PACF point of view. 

```{r}
# ARIMA(2,1,5)(0,1,1)[12]
ms.training %>% Arima(order = c(2, 1, 5), seasonal=list(order=c(0,1,1),period=12)) %>% ggtsdiag()
# ARIMA(5,1,0)(0,1,1)[12]
ms.training %>% Arima(order = c(5, 1, 0), seasonal=list(order=c(0,1,1),period=12)) %>% ggtsdiag()

# ARIMA(2,1,5)(0,1,1)[12]
ms.training %>% Arima(order = c(2, 1, 5), seasonal=list(order=c(0,1,1),period=12)) %>% summary()
# ARIMA(5,1,0)(0,1,1)[12]
ms.training %>% Arima(order = c(5, 1, 0), seasonal=list(order=c(0,1,1),period=12)) %>% summary()
```

We'll now conduct a grid search to see if any other model provide an enhancement over these models.

```{r}
results <- data.frame(p = 1:25, q = 1:25, AIC = 0, AICc = 0, BIC = 0)
for (p in 1:5){
  for (q in 1:5){
    m <- ms.training %>% Arima(order = c(p, 1, q), seasonal=list(order=c(0,1,1),period=12))
    index <- (p-1)*5 + q
    results[index,] = c(p,q,m$aic, m$aicc, m$bic)
  }
}
results[which.min(results$AIC),]
results[which.min(results$AICc),]
results[which.min(results$BIC),]
```

## Candidate models
Based on the exploratory analysis and grid search, we are going to focus on the following 4 models  
- ARIMA(2,1,5)(0,1,1)[12] (based on earlier EDA)
- ARIMA(5,1,0)(0,1,1)[12] (based on earlier EDA)
- ARIMA(1,1,1)(0,1,1)[12] (minimizes BIC)
- ARIMA(2,1,1)(0,1,1)[12] (minimizes AIC / AICc)

```{r}
f1 <- ms.training %>% Arima(order = c(2, 1, 5), seasonal=list(order=c(0,1,1),period=12)) %>% forecast(h = 11)
f2 <- ms.training %>% Arima(order = c(5, 1, 0), seasonal=list(order=c(0,1,1),period=12)) %>% forecast(h = 11)
f3 <- ms.training %>% Arima(order = c(1, 1, 1), seasonal=list(order=c(0,1,1),period=12)) %>% forecast(h = 11)
f4 <- ms.training %>% Arima(order = c(2, 1, 1), seasonal=list(order=c(0,1,1),period=12)) %>% forecast(h = 11)

results <- round(rbind( accuracy(f1,ms.test),
                  accuracy(f2,ms.test),
                  accuracy(f3,ms.test),
                  accuracy(f4,ms.test)),2)

results
```

# To Do
validate the model by doing residual analysis (q-q plot, etc...)

```{r}
ms <- as.xts(ts(df$x, start = c(1990,1), frequency = 12))
ms.training <- ms['/2014']
ms.test <- ms['2015/']
f1 <- ms.training %>% Arima(order = c(2, 1, 5), seasonal=list(order=c(0,1,1),period=12)) %>% forecast(h = 11)
f2 <- ms.training %>% Arima(order = c(5, 1, 0), seasonal=list(order=c(0,1,1),period=12)) %>% forecast(h = 11)
f3 <- ms.training %>% Arima(order = c(1, 1, 1), seasonal=list(order=c(0,1,1),period=12)) %>% forecast(h = 11)
f4 <- ms.training %>% Arima(order = c(2, 1, 1), seasonal=list(order=c(0,1,1),period=12)) %>% forecast(h = 11)

results <- round(rbind( accuracy(f1,ms.test),
                  accuracy(f2,ms.test),
                  accuracy(f3,ms.test),
                  accuracy(f4,ms.test)),2)

results
```
